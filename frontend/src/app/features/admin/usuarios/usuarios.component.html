<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h2 mb-3">Gestión de Usuarios</h1>

      <!-- Estadísticas -->
      @if (estadisticas()) {
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="text-muted mb-2">Total Usuarios</h6>
                <h3 class="mb-0">{{ estadisticas()!.total }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="text-muted mb-2">Activos / Inactivos</h6>
                <h3 class="mb-0">{{ estadisticas()!.activos }} / {{ estadisticas()!.inactivos }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="text-muted mb-2">Admins / Usuarios</h6>
                <h3 class="mb-0">{{ estadisticas()!.porRol.admins }} / {{ estadisticas()!.porRol.usuarios }}</h3>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Filtros -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <input
                type="text"
                class="form-control"
                placeholder="Buscar por nombre o email..."
                #busquedaInput
                (input)="buscar(busquedaInput.value)"
              />
            </div>
            <div class="col-md-3">
              <select class="form-select" (change)="filtrarPorRol($any($event.target).value)">
                <option value="todos">Todos los roles</option>
                <option value="admin">Administradores</option>
                <option value="usuario">Usuarios</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" (change)="filtrarPorEstado($any($event.target).value)">
                <option value="todos">Todos los estados</option>
                <option value="activos">Activos</option>
                <option value="inactivos">Inactivos</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" (click)="cargarDatos()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de usuarios -->
      @if (cargando()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      } @else {
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Email Verificado</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  @for (usuario of usuarios(); track usuario.id) {
                    <tr>
                      <td>{{ usuario.id }}</td>
                      <td>{{ usuario.nombre }}</td>
                      <td>{{ usuario.email }}</td>
                      <td>
                        <span [class]="obtenerRolBadgeClass(usuario.rol)">
                          {{ obtenerRolLabel(usuario.rol) }}
                        </span>
                      </td>
                      <td>
                        <span [class]="obtenerEstadoBadgeClass(usuario.activo)">
                          {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                        </span>
                      </td>
                      <td>
                        @if (usuario.emailVerificado) {
                          <i class="bi bi-check-circle-fill text-success"></i>
                        } @else {
                          <i class="bi bi-x-circle-fill text-danger"></i>
                        }
                      </td>
                      <td>{{ formatearFecha(usuario.createdAt) }}</td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button
                            class="btn btn-outline-primary"
                            (click)="abrirModalEditar(usuario)"
                            title="Editar"
                          >
                            <i class="bi bi-pencil"></i>
                          </button>

                          @if (usuario.id !== authService.usuario()?.id) {
                            @if (usuario.activo) {
                              <button
                                class="btn btn-outline-danger"
                                (click)="abrirModalEliminar(usuario)"
                                title="Desactivar"
                              >
                                <i class="bi bi-trash"></i>
                              </button>
                            } @else {
                              <button
                                class="btn btn-outline-success"
                                (click)="abrirModalReactivar(usuario)"
                                title="Reactivar"
                              >
                                <i class="bi bi-arrow-clockwise"></i>
                              </button>
                            }

                            <button
                              class="btn btn-outline-warning"
                              (click)="abrirModalCambiarRol(usuario)"
                              title="Cambiar rol"
                            >
                              <i class="bi bi-shield"></i>
                            </button>
                          }
                        </div>
                      </td>
                    </tr>
                  } @empty {
                    <tr>
                      <td colspan="8" class="text-center py-4">
                        No se encontraron usuarios
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            @if (paginacion() && paginacion().totalPaginas > 1) {
              <nav class="mt-3">
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="paginacion().paginaActual === 1">
                    <button class="page-link" (click)="cambiarPagina(paginacion().paginaActual - 1)">
                      Anterior
                    </button>
                  </li>

                  @for (pagina of [].constructor(paginacion().totalPaginas); track $index; let i = $index) {
                    <li class="page-item" [class.active]="i + 1 === paginacion().paginaActual">
                      <button class="page-link" (click)="cambiarPagina(i + 1)">
                        {{ i + 1 }}
                      </button>
                    </li>
                  }

                  <li class="page-item" [class.disabled]="paginacion().paginaActual === paginacion().totalPaginas">
                    <button class="page-link" (click)="cambiarPagina(paginacion().paginaActual + 1)">
                      Siguiente
                    </button>
                  </li>
                </ul>
              </nav>
            }
          </div>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modal -->
@if (mostrarModal()) {
  <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            @switch (accionModal) {
              @case ('editar') { Editar Usuario }
              @case ('eliminar') { Desactivar Usuario }
              @case ('reactivar') { Reactivar Usuario }
              @case ('cambiarRol') { Cambiar Rol }
            }
          </h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>

        <div class="modal-body">
          @switch (accionModal) {
            @case ('editar') {
              <form>
                <div class="mb-3">
                  <label class="form-label">Nombre</label>
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="formulario.nombre"
                    name="nombre"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    [(ngModel)]="formulario.email"
                    name="email"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Nueva Contraseña (opcional)</label>
                  <input
                    type="password"
                    class="form-control"
                    [(ngModel)]="formulario.password"
                    name="password"
                    placeholder="Dejar en blanco para no cambiar"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Rol</label>
                  <select class="form-select" [(ngModel)]="formulario.rol" name="rol">
                    <option value="usuario">Usuario</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
                <div class="mb-3 form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    [(ngModel)]="formulario.activo"
                    name="activo"
                    id="activo"
                  />
                  <label class="form-check-label" for="activo">
                    Usuario activo
                  </label>
                </div>
              </form>
            }

            @case ('eliminar') {
              <p>¿Está seguro de que desea desactivar al usuario <strong>{{ usuarioSeleccionado()?.nombre }}</strong>?</p>
              <p class="text-muted">El usuario no podrá acceder al sistema pero sus datos se conservarán.</p>
            }

            @case ('reactivar') {
              <p>¿Está seguro de que desea reactivar al usuario <strong>{{ usuarioSeleccionado()?.nombre }}</strong>?</p>
              <p class="text-muted">El usuario podrá volver a acceder al sistema.</p>
            }

            @case ('cambiarRol') {
              <p>¿Está seguro de que desea cambiar el rol del usuario <strong>{{ usuarioSeleccionado()?.nombre }}</strong>?</p>
              <div class="alert alert-info">
                <strong>Rol actual:</strong> {{ obtenerRolLabel(usuarioSeleccionado()!.rol) }}<br>
                <strong>Nuevo rol:</strong> {{ obtenerRolLabel(nuevoRol) }}
              </div>
            }
          }
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            Cancelar
          </button>
          @switch (accionModal) {
            @case ('editar') {
              <button type="button" class="btn btn-primary" (click)="guardarUsuario()">
                Guardar Cambios
              </button>
            }
            @case ('eliminar') {
              <button type="button" class="btn btn-danger" (click)="eliminarUsuario()">
                Desactivar
              </button>
            }
            @case ('reactivar') {
              <button type="button" class="btn btn-success" (click)="reactivarUsuario()">
                Reactivar
              </button>
            }
            @case ('cambiarRol') {
              <button type="button" class="btn btn-warning" (click)="cambiarRolUsuario()">
                Cambiar Rol
              </button>
            }
          }
        </div>
      </div>
    </div>
  </div>
}
